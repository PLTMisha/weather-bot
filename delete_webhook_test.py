#!/usr/bin/env python3
"""
Delete webhook and test polling
"""
import asyncio
import logging
from aiogram import Bot, Dispatcher
from aiogram.types import Message
from aiogram.filters import Command
from config import settings
from database import init_db

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

async def delete_webhook_and_test():
    """Delete webhook and test with polling"""
    print("=== Deleting Webhook and Testing Polling ===")
    
    bot = Bot(token=settings.telegram_bot_token)
    
    try:
        # Delete webhook
        print("–£–¥–∞–ª—è–µ–º webhook...")
        await bot.delete_webhook(drop_pending_updates=True)
        print("‚úÖ Webhook deleted")
        
        # Check webhook status
        webhook_info = await bot.get_webhook_info()
        print(f"Webhook URL after deletion: {webhook_info.url}")
        print(f"Pending updates: {webhook_info.pending_update_count}")
        
        if not webhook_info.url:
            print("‚úÖ Webhook successfully removed")
            
            # Initialize database
            await init_db()
            print("‚úÖ Database initialized")
            
            # Create dispatcher
            dp = Dispatcher()
            
            # Simple start handler
            @dp.message(Command("start"))
            async def cmd_start_test(message: Message):
                logger.info(f"Received /start from user {message.from_user.id}")
                await message.answer("üéâ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ polling! –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ.")
                print(f"‚úÖ Processed /start from {message.from_user.first_name}")
            
            print("‚úÖ Handlers registered")
            print("üöÄ Starting polling for 30 seconds...")
            print("–û—Ç–ø—Ä–∞–≤—å—Ç–µ /start –±–æ—Ç—É @mishatgtestbot –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!")
            
            # Start polling with timeout
            try:
                await asyncio.wait_for(
                    dp.start_polling(bot, skip_updates=True),
                    timeout=30.0
                )
            except asyncio.TimeoutError:
                print("‚è∞ Polling timeout (30 seconds)")
            
            print("‚úÖ Polling test completed")
        else:
            print("‚ùå Failed to delete webhook")
        
    except Exception as e:
        logger.error(f"Error: {e}")
        print(f"‚ùå Error: {e}")
    
    finally:
        try:
            await bot.session.close()
        except:
            pass

if __name__ == "__main__":
    asyncio.run(delete_webhook_and_test())
