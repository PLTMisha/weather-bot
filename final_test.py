#!/usr/bin/env python3
"""
Final test of the weather bot
"""
import asyncio
import httpx
import time
from datetime import datetime

async def final_test():
    """Final test of webhook and bot functionality"""
    print("=== Final Weather Bot Test ===")
    print(f"Time: {datetime.now()}")
    print()
    print("–ò–ù–°–¢–†–£–ö–¶–ò–Ø:")
    print("1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ Render.com")
    print("2. –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ (1-2 –º–∏–Ω—É—Ç—ã)")
    print("3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ /start –±–æ—Ç—É @weathertownsbot")
    print("4. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞")
    print()
    
    input("–ù–∞–∂–º–∏—Ç–µ Enter –ü–û–°–õ–ï –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –Ω–∞ Render...")
    
    print("–ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞...")
    await asyncio.sleep(10)
    
    # Test webhook endpoint
    print("\n–¢–µ—Å—Ç–∏—Ä—É–µ–º webhook endpoint...")
    try:
        async with httpx.AsyncClient(timeout=10.0) as client:
            # Test root endpoint
            response = await client.get("https://weather-bot-y5fd.onrender.com/")
            print(f"Root endpoint: {response.status_code}")
            
            if response.status_code == 200:
                print("‚úÖ –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç")
                
                # Test webhook with sample update
                test_update = {
                    "update_id": int(time.time()),
                    "message": {
                        "message_id": 1,
                        "from": {
                            "id": 123456789,
                            "is_bot": False,
                            "first_name": "Test",
                            "username": "testuser",
                            "language_code": "en"
                        },
                        "chat": {
                            "id": 123456789,
                            "first_name": "Test",
                            "username": "testuser",
                            "type": "private"
                        },
                        "date": int(time.time()),
                        "text": "/start",
                        "entities": [
                            {
                                "offset": 0,
                                "length": 6,
                                "type": "bot_command"
                            }
                        ]
                    }
                }
                
                webhook_response = await client.post(
                    "https://weather-bot-y5fd.onrender.com/webhook",
                    json=test_update,
                    headers={"Content-Type": "application/json"}
                )
                
                print(f"Webhook test: {webhook_response.status_code}")
                
                if webhook_response.status_code == 200:
                    print("‚úÖ Webhook —Ä–∞–±–æ—Ç–∞–µ—Ç")
                else:
                    print("‚ùå Webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç")
            else:
                print("‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç")
                
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: {e}")
    
    print("\n" + "="*50)
    print("üéâ –§–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù!")
    print("–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /start –±–æ—Ç—É @weathertownsbot")
    print("–ï—Å–ª–∏ –±–æ—Ç –æ—Ç–≤–µ—Ç–∏—Ç - –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ!")
    print("="*50)

if __name__ == "__main__":
    asyncio.run(final_test())
