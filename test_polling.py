#!/usr/bin/env python3
"""
Test bot with polling instead of webhook to check if handlers work
"""
import asyncio
import logging
from aiogram import Bot, Dispatcher
from aiogram.types import Message
from aiogram.filters import Command
from config import settings
from database import init_db, DatabaseManager
from bot import weather_bot

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

async def test_polling():
    """Test bot with polling"""
    print("=== Testing Bot with Polling ===")
    print("–≠—Ç–æ—Ç —Ç–µ—Å—Ç –∑–∞–ø—É—Å—Ç–∏—Ç –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ polling –Ω–∞ 30 —Å–µ–∫—É–Ω–¥")
    print("–û—Ç–ø—Ä–∞–≤—å—Ç–µ /start –±–æ—Ç—É @mishatgtestbot –≤ Telegram")
    print("–ï—Å–ª–∏ –±–æ—Ç –æ—Ç–≤–µ—Ç–∏—Ç, –∑–Ω–∞—á–∏—Ç –ø—Ä–æ–±–ª–µ–º–∞ –≤ webhook")
    print("–ï—Å–ª–∏ –Ω–µ –æ—Ç–≤–µ—Ç–∏—Ç, –∑–Ω–∞—á–∏—Ç –ø—Ä–æ–±–ª–µ–º–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö")
    print()
    
    try:
        # Initialize database
        await init_db()
        print("‚úÖ Database initialized")
        
        # Create bot and dispatcher
        bot = Bot(token=settings.telegram_bot_token)
        dp = Dispatcher()
        
        # Simple start handler for testing
        @dp.message(Command("start"))
        async def cmd_start_test(message: Message):
            logger.info(f"Received /start from user {message.from_user.id}")
            await message.answer("üéâ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç! –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ.")
            print(f"‚úÖ Processed /start from {message.from_user.first_name}")
        
        # Register all original handlers
        weather_bot.register_handlers()
        
        print("‚úÖ Handlers registered")
        print("üöÄ Starting polling for 30 seconds...")
        print("–û—Ç–ø—Ä–∞–≤—å—Ç–µ /start –±–æ—Ç—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!")
        
        # Start polling with timeout
        try:
            await asyncio.wait_for(
                dp.start_polling(bot, skip_updates=True),
                timeout=30.0
            )
        except asyncio.TimeoutError:
            print("‚è∞ Polling timeout (30 seconds)")
        
        print("‚úÖ Polling test completed")
        
    except Exception as e:
        logger.error(f"Error in polling test: {e}")
        print(f"‚ùå Error: {e}")
    
    finally:
        try:
            await bot.session.close()
        except:
            pass

if __name__ == "__main__":
    asyncio.run(test_polling())
