#!/usr/bin/env python3
"""
Temporary polling bot while Render token is being updated
"""
import asyncio
import logging
from aiogram import Bot, Dispatcher
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Command
from config import settings
from database import init_db
from bot import weather_bot

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

async def run_polling_bot():
    """Run bot with polling temporarily"""
    print("=== –í—Ä–µ–º–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ Polling ===")
    print("–≠—Ç–æ—Ç –±–æ—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–∫–∞ –≤—ã –Ω–µ –æ–±–Ω–æ–≤–∏—Ç–µ —Ç–æ–∫–µ–Ω –Ω–∞ Render")
    print("–û—Ç–ø—Ä–∞–≤—å—Ç–µ /start –±–æ—Ç—É @weathertownsbot")
    print("–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C")
    print()
    
    try:
        # Initialize database
        await init_db()
        print("‚úÖ Database initialized")
        
        # Create bot and dispatcher
        bot = Bot(token=settings.telegram_bot_token)
        dp = Dispatcher()
        
        # Get bot info
        bot_info = await bot.get_me()
        print(f"‚úÖ Bot connected: @{bot_info.username}")
        
        # Delete webhook to avoid conflicts
        await bot.delete_webhook(drop_pending_updates=True)
        print("‚úÖ Webhook deleted for polling")
        
        # Register all handlers from weather_bot
        weather_bot.register_handlers()
        
        # Copy handlers to our dispatcher
        dp.message.handlers = weather_bot.dp.message.handlers
        dp.callback_query.handlers = weather_bot.dp.callback_query.handlers
        
        print("‚úÖ Handlers registered")
        print("üöÄ Starting polling...")
        print("–ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
        
        # Start polling
        await dp.start_polling(bot, skip_updates=True)
        
    except KeyboardInterrupt:
        print("\n‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...")
    except Exception as e:
        logger.error(f"Error: {e}")
        print(f"‚ùå Error: {e}")
    finally:
        try:
            await bot.session.close()
        except:
            pass
        print("‚úÖ Bot stopped")

if __name__ == "__main__":
    asyncio.run(run_polling_bot())
